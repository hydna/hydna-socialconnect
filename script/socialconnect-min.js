window.SocialConnect=(function(){var a="already_connected";var f="invalid_token";var c="claim_first";var e="facebook_auth_error";var d=["facebook"];function b(h,i){var g=this;g._socialnetwork=i;g._me_channel=null;g._uuid="";g._domain_addr=h;g._connected=false;g._connecting=false;g._public_connected=false;g._connected_friends={};g._friends=[];g._public_channel=null;g._message_que={}}b.prototype.connect=function(i,h){var g=this;if(!g._connected&&!g._connecting){g._connecting=true;g._uuid=i;g._me_channel=new HydnaChannel(g._domain_addr+"/"+g._socialnetwork+"/"+g._uuid+"?"+h,"r");g._me_channel.onopen=function(j){g._connected=true;g._connecting=false;g.connectPublic()};g._me_channel.onclose=function(j){if(j.wasDenied){g.onerror&&g.onerror(j.reason)}};g._me_channel.onsignal=function(j){var l=null;try{var l=JSON.parse(j.data)}catch(k){}if(l!==null){if("type" in l){if(l.type==="ping"&&l.data!==g._uuid){g.connectFriend(l.data)}if(l.type==="close"&&l.data!==g._uuid){g.disconnectFriend(l.data)}}}};g._me_channel.onmessage=function(j){var l=null;try{l=JSON.parse(j.data)}catch(k){}if(l!==null){g.onfriendmessage&&g.onfriendmessage(g.getFriendProperties(l.id),l.data)}}}};b.prototype.connectPublic=function(){var g=this;if(!g._public_channel){g._public_channel=new HydnaChannel(g._domain_addr+"/"+g._socialnetwork+"?"+g._uuid);g._public_channel.onopen=function(h){g._public_connected=true};g._public_channel.onclose=function(h){if(h.wasDenied){g.onerror&&g.onerror(h.reason)}};g._public_channel.onsignal=function(h){var j=null;try{var j=JSON.parse(h.data)}catch(i){}if(j!=null){if("type" in j){if(j.type==="joined"&&j.data!==g._uuid){g.connectFriend(j.data)}if(j.type==="left"&&j.data!==g._uuid){g.disconnectFriend(j.data)}}}}}};b.prototype.send=function(h){if(this._connected){for(var i in this._connected_friends){var g=this._connected_friends[i];if(g.readyState===HydnaChannel.OPEN){g.send(JSON.stringify({id:this._uuid,data:h}))}else{if(this._message_que[i]!=null){this._message_que[i].push(h)}else{this._message_que[i]=[h]}}}}else{throw (new Error("Not connected"))}};b.prototype.addFriends=function(g){this._friends=g};b.prototype.disconnectFriend=function(g){if(this._connected_friends[g]){this._connected_friends[g].close();this._connected_friends[g]=null}};b.prototype.connectFriend=function(i){var g=this;if(!g.isFriendListed(i)){g.onerror&&g.onerror("This is not your friend");return}if(g._connected&&!g._connected_friends[i]){var h=new HydnaChannel(g._domain_addr+"/"+g._socialnetwork+"/"+i,"w");h.onopen=function(k){if(g._message_que[i]!=null){for(var j in g._message_que[i]){h.send(JSON.stringify({id:i,data:g._message_que[i][j]}))}g._message_que[i]=null}g.onfriendopen&&g.onfriendopen(g.getFriendProperties(i))};h.onclose=function(j){if(!j.wasDenied){g.onfriendclose&&g.onfriendclose(g.getFriendProperties(i));g._message_que[i]==null}};h.onsignal=function(j){var l=null;try{var l=JSON.parse(j.data)}catch(k){}if(l!=null){if("type" in l){if(l.type==="joined"&&l.data!==g._uuid){g.connectFriend(l.data)}if((l.type==="left"||l.type==="close")&&l.data!==g._uuid){g.disconnectFriend(l.data)}}}};g._connected_friends[i]=h}};b.prototype.getConnectedFriends=function(){var j=[];for(var h in this._connected_friends){if(this._connected_friends[h].readyState===HydnaChannel.OPEN){var g={id:id};j.push(this.getFriendProperties(id))}}return j};b.prototype.isFriendListed=function(h){for(var g in this._friends){if(this._friends[g].id===h){return true}}return false};b.prototype.getFriendProperties=function(h){for(var g in this._friends){if(this._friends[g].id===h){return this._friends[g]}}return null};b.prototype.destroy=function(){if(this._connected){if(this._me_channel!==null){this._me_channel.close();this._me_channel=null}for(var g in this._connected_friends){this._connected_friends[g].close();this._connected_friends[g]=null}if(this._public_channel!==null){this._public_channel.close();this._public_channel=null}this._message_que={};this._public_connected=false;this._connected=false;this._connecting=false;this._connected_friends={};this._friends=[]}};return b})();